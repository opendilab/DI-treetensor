

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Stack Structured Data &mdash; DI-treetensor 0.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Customized Operations For Different Fields" href="../operation/index.html" />
    <link rel="prev" title="Plugins" href="../../tutorials/plugins/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> DI-treetensor
          

          
          </a>

          
            
            
              <div class="version">
                0.2.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/quick_start/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/plugins/index.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Best Practice</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Stack Structured Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#stack-with-native-pytorch-api">Stack With Native PyTorch API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stack-with-treetensor-api">Stack With TreeTensor API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../operation/index.html">Customized Operations For Different Fields</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/common/index.html">treetensor.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/config/index.html">treetensor.config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/numpy/index.html">treetensor.numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/torch/index.html">treetensor.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/utils/index.html">treetensor.utils</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DI-treetensor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Stack Structured Data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/best_practice/stack/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
    
    
  <div class="section" id="stack-structured-data">
<h1>Stack Structured Data<a class="headerlink" href="#stack-structured-data" title="Permalink to this headline">¶</a></h1>
<p>When the tensors form the tree structures, they are often needed to be stacked together, like the <a class="reference internal" href="../../api_doc/torch/funcs.stack.auto.html#torch.stack" title="torch.stack"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.stack()</span></code></a> implemented in torch.</p>
<div class="section" id="stack-with-native-pytorch-api">
<h2>Stack With Native PyTorch API<a class="headerlink" href="#stack-with-native-pytorch-api" title="Permalink to this headline">¶</a></h2>
<p>Here is the common code implement with native pytorch API.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="n">B</span> <span class="o">=</span> <span class="mi">4</span>


<span class="k">def</span> <span class="nf">get_item</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;obs&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;scalar&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
        <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>


<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_item</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">)]</span>


<span class="c1"># execute `stack` op</span>
<span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
    <span class="n">elem</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">stack</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">],</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;not support elem type: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">elem</span><span class="p">)))</span>


<span class="n">stacked_data</span> <span class="o">=</span> <span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># validate</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stacked_data</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">][</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">bool</span>
</pre></div>
</td></tr></table></div>
<p>The output should be like below, and the assertion statements can be all passed.</p>
<div class="highlight-text notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>{&#39;obs&#39;: {&#39;scalar&#39;: tensor([[-0.2273,  1.0931,  0.5797, -0.2428,  1.8081, -0.1031, -0.4596, -1.4993,
          1.9681, -1.1688,  0.3986,  0.1912],
        [-0.7718, -0.7797, -0.7748, -0.6604,  0.1783,  1.1317,  0.1767, -0.4787,
         -1.2613,  1.2391, -2.1214, -0.2863],
        [ 0.7590, -1.3780,  0.2000,  0.0504,  1.0692, -0.7548, -1.2732,  0.5357,
          1.4270,  0.8629, -0.0536,  0.2829],
        [-0.7987, -0.0174, -1.4484, -0.9295, -1.4992,  0.9814, -0.0331, -0.1275,
         -0.5679,  0.3045, -0.1390,  0.9291]]), &#39;image&#39;: tensor([[[[ 0.6861, -0.0765,  1.0573,  ..., -0.5154, -0.5244, -1.3447],
          [ 0.3866, -1.0338, -1.0584,  ..., -0.7317, -0.4286, -0.8085],
          [ 0.7367,  0.7775, -0.7719,  ..., -0.6393,  0.5421,  0.7440],
          ...,
          [ 0.0769, -0.1835,  0.8711,  ..., -0.3140,  0.8811, -0.6449],
          [-1.2989, -1.2921,  1.6376,  ...,  0.3506,  2.0596,  1.8036],
          [-0.8709, -0.4518, -1.5303,  ...,  0.1226,  0.3482, -0.6399]],

         [[-0.3548, -1.0538, -0.6088,  ...,  0.7389, -0.0672, -0.7217],
          [-0.5637, -0.2296,  0.2963,  ...,  1.0031, -0.1708,  0.7550],
          [ 0.7345, -0.0372, -0.3435,  ...,  1.2397, -0.6234, -0.1168],
          ...,
          [-0.8005, -1.8208,  1.4628,  ...,  0.2219, -1.5759,  1.8283],
          [-1.2144,  0.3464, -0.7266,  ...,  0.8272,  0.2802,  1.4542],
          [-0.4542,  0.1305,  1.6596,  ..., -0.5781,  1.2213,  0.0041]],

         [[ 0.9749,  1.0641, -1.2773,  ..., -1.1542, -0.0402, -0.3386],
          [ 0.1641,  0.4025,  0.7193,  ...,  0.0444,  3.0001, -0.8163],
          [-0.8106,  0.5968,  0.4392,  ..., -0.1518,  1.6335,  1.7221],
          ...,
          [-0.4783, -0.1356,  0.3156,  ...,  0.7332,  0.4662,  1.5698],
          [ 0.3986, -0.3992, -0.1236,  ...,  0.1850,  0.3870, -1.7318],
          [-0.7326,  0.5151,  1.9464,  ..., -0.3667, -1.8646, -1.9170]]],


        [[[ 1.3775,  0.2788,  2.9681,  ..., -0.0288, -1.7627, -1.0762],
          [-0.6266,  0.1369,  1.1049,  ...,  0.4153, -1.2041,  2.2972],
          [ 0.5865,  0.3674,  0.9121,  ...,  1.3789, -0.7522, -1.1426],
          ...,
          [ 2.1743, -0.8856, -0.9810,  ..., -1.1764, -0.6438,  0.8324],
          [-1.0996,  1.4831, -2.0231,  ..., -0.7799, -0.3372, -0.8669],
          [-0.1200,  2.5554,  0.0632,  ...,  1.3251,  1.2970, -0.3399]],

         [[-0.1614,  0.7163, -1.0308,  ...,  0.4889, -0.4284, -1.2971],
          [ 0.4919,  0.4391, -1.9956,  ...,  1.4316, -0.6360, -0.3125],
          [ 1.5568,  0.5568,  0.3250,  ...,  0.0808,  0.2464, -0.8945],
          ...,
          [ 0.6409,  1.1567,  2.3608,  ..., -1.1935, -0.2695,  0.7522],
          [ 0.3283, -1.8213,  1.1044,  ..., -0.1424,  0.0316, -0.0866],
          [ 0.4855, -0.2713,  1.1775,  ..., -0.1514,  0.5205,  0.3540]],

         [[ 1.5717,  1.8883,  0.3265,  ..., -1.4153, -0.8225,  0.7027],
          [ 0.5905,  0.0809,  1.2713,  ...,  0.0534,  0.2440, -1.6134],
          [ 0.1878, -0.2070, -0.3728,  ...,  0.2625, -1.4001,  1.5035],
          ...,
          [-0.7907,  0.4883,  0.8675,  ..., -1.1589,  0.4035,  1.3758],
          [ 0.3089, -0.5272,  0.6754,  ..., -0.3273, -1.0654,  1.3754],
          [-0.3172, -0.3211, -0.8540,  ..., -2.3800, -0.5041,  1.8352]]],


        [[[-0.1804,  0.5552, -0.5351,  ...,  0.3498,  1.4859, -3.0226],
          [ 0.1123,  0.6028,  0.6373,  ...,  1.1928,  0.9801,  1.6225],
          [-1.8358, -0.1980,  0.4526,  ..., -1.0857,  0.1158,  0.1271],
          ...,
          [ 1.5293, -0.3726,  0.8931,  ..., -1.6617, -1.3685,  0.9971],
          [ 1.7432,  0.5395,  0.2987,  ..., -0.5116,  0.5219, -0.5499],
          [-0.3311,  0.1692,  0.0909,  ..., -1.0151,  0.1467, -0.1477]],

         [[ 0.4232, -0.0864, -1.3034,  ...,  1.2919, -0.8521,  0.0475],
          [-1.0111, -1.5206,  2.1317,  ..., -1.1364, -0.2947, -0.0450],
          [ 0.7129, -0.7983,  0.5985,  ...,  0.1873, -0.5419, -0.0469],
          ...,
          [-0.1302, -0.2701,  2.7606,  ..., -0.6388,  0.6855, -0.1204],
          [ 0.5622, -1.3790, -1.5786,  ...,  0.3372, -0.4854,  0.9396],
          [-0.2005, -2.4156, -0.0550,  ...,  0.3751, -0.2319,  0.4597]],

         [[-0.6788,  0.5847, -0.5758,  ..., -0.2068, -0.5760,  0.7557],
          [ 0.1608, -0.1786,  1.0102,  ..., -1.5779,  0.1995,  1.1237],
          [-1.9873,  2.1232,  1.2948,  ..., -0.8591,  0.7354,  0.4018],
          ...,
          [-0.5657,  0.3068,  0.6668,  ...,  0.0916,  0.6531, -1.2037],
          [ 0.0481, -2.3388, -0.2650,  ..., -0.0206, -1.7450, -1.3120],
          [-0.2504, -0.2471, -0.9983,  ..., -0.6890, -1.2623,  0.0305]]],


        [[[-0.8045, -2.2166, -1.6334,  ..., -0.6112, -2.3039, -1.1387],
          [ 1.8949, -0.6181, -1.3089,  ...,  0.2119, -0.0460,  0.2671],
          [-0.1011,  0.9904,  0.3640,  ...,  0.3838,  0.6455, -0.3556],
          ...,
          [-0.2397,  0.0281,  1.1647,  ..., -2.4303, -0.9910, -0.8620],
          [-0.4472, -1.0030,  0.8822,  ...,  0.4567,  0.1135,  0.8108],
          [-0.6886, -0.5861,  0.5101,  ...,  0.3142, -0.3622,  0.4112]],

         [[-1.4329,  1.2413, -0.4272,  ..., -1.1509,  0.1440,  0.2285],
          [ 0.5029,  0.0451,  1.0681,  ...,  0.4622,  0.3397, -0.6829],
          [ 0.3790, -1.4938, -0.2518,  ...,  0.0376,  1.2349, -0.0751],
          ...,
          [-0.1654,  0.1092,  0.5915,  ..., -0.6424, -0.7271, -0.3354],
          [-0.5937,  0.7852, -1.7746,  ..., -0.1083, -0.1796, -0.0877],
          [-0.4122, -0.5960,  0.0204,  ...,  1.2999, -0.4070,  0.9100]],

         [[-1.4959, -0.0113,  0.3223,  ...,  1.3694,  0.8778,  0.0230],
          [ 0.5017,  1.8619, -0.7675,  ..., -0.1440,  1.1454, -1.3416],
          [ 0.7774,  0.4407, -0.2206,  ...,  0.2467,  0.8746,  0.1451],
          ...,
          [-0.2130,  0.4482,  0.3267,  ...,  0.5287, -0.0102, -1.3285],
          [ 1.3557, -0.5961,  0.8430,  ...,  1.3782,  0.6086, -1.2389],
          [-0.8351, -1.1119, -0.1496,  ...,  2.0097,  0.2349, -0.1664]]]])}, &#39;action&#39;: tensor([[8],
        [7],
        [9],
        [5]]), &#39;reward&#39;: tensor([[0.9335],
        [0.5226],
        [0.3687],
        [0.9876]]), &#39;done&#39;: tensor([False, False, False, False])}
</pre></div>
</td></tr></table></div>
<p>We can see that the structure process function need to be fully implemented (like the function <code class="docutils literal notranslate"><span class="pre">stack</span></code>). This code is actually not clear, and due to hard coding, if you need to support more data types (such as integer), you must make special modifications to the function.</p>
</div>
<div class="section" id="stack-with-treetensor-api">
<h2>Stack With TreeTensor API<a class="headerlink" href="#stack-with-treetensor-api" title="Permalink to this headline">¶</a></h2>
<p>The same workflow can be implemented with treetensor API like the code below.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">import</span> <span class="nn">treetensor.torch</span> <span class="k">as</span> <span class="nn">ttorch</span>

<span class="n">B</span> <span class="o">=</span> <span class="mi">4</span>


<span class="k">def</span> <span class="nf">get_item</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;obs&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;scalar&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
        <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>


<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_item</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">)]</span>
<span class="c1"># execute `stack` op</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">ttorch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
<span class="n">stacked_data</span> <span class="o">=</span> <span class="n">ttorch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># validate</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stacked_data</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="o">.</span><span class="n">reward</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">bool</span>
</pre></div>
</td></tr></table></div>
<p>The output should be like below, and the assertion statements can be all passed as well.</p>
<div class="highlight-text notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>&lt;Tensor 0x7ff236da3390&gt;
├── action --&gt; tensor([[2],
│                      [7],
│                      [4],
│                      [5]])
├── done --&gt; tensor([False, False, False, False])
├── obs --&gt; &lt;Tensor 0x7ff236da33d0&gt;
│   ├── image --&gt; tensor([[[[-2.2725, -1.1463, -1.5533,  ...,  2.0786,  0.6770,  0.2103],
│   │                       [ 0.3701,  0.6404,  0.9727,  ...,  0.1162,  0.8409,  1.0785],
│   │                       [-0.8381,  1.0326,  0.9467,  ..., -1.1934, -0.9808,  0.2739],
│   │                       ...,
│   │                       [ 0.3587,  1.0824,  0.1480,  ...,  1.4750, -1.5358, -0.4335],
│   │                       [ 2.0889,  1.0373, -0.3747,  ...,  0.5707, -0.4472, -0.4252],
│   │                       [-0.1919, -1.4688,  0.0941,  ...,  0.8525,  0.8052, -1.4526]],
│   │             
│   │                      [[ 1.0213,  0.1759, -1.2068,  ..., -0.4399,  0.8189, -2.7132],
│   │                       [ 1.0215,  0.2888, -1.0724,  ..., -0.1208,  0.4894, -0.5226],
│   │                       [ 0.2183,  0.6773,  0.0038,  ..., -0.0457, -0.7125, -0.8988],
│   │                       ...,
│   │                       [ 1.1289,  1.3065, -0.4238,  ..., -0.0898,  0.1375, -0.3391],
│   │                       [-1.4552, -0.0040,  0.2982,  ...,  0.5721, -0.8739, -0.3007],
│   │                       [ 0.0521,  2.1497,  1.3902,  ...,  1.0896, -0.5202, -1.0138]],
│   │             
│   │                      [[ 1.1432, -1.1263, -0.1173,  ..., -0.5422,  0.8523,  0.7609],
│   │                       [ 0.0820, -0.4475,  0.0117,  ...,  0.5513, -0.3401,  0.2353],
│   │                       [ 0.5452,  1.0398,  0.4845,  ..., -0.5347, -0.8646, -0.5370],
│   │                       ...,
│   │                       [ 0.4691, -1.0643,  0.1923,  ...,  0.9423, -1.2153, -0.4779],
│   │                       [ 1.6076, -1.3436,  1.1056,  ...,  0.6381,  0.9844,  0.0519],
│   │                       [ 0.5270,  2.1164,  0.2014,  ..., -0.1495, -0.5011, -1.1290]]],
│   │             
│   │             
│   │                     [[[-0.4441, -0.9677, -0.4529,  ...,  2.0433, -0.8544,  0.0424],
│   │                       [ 1.1334, -0.3906,  0.9910,  ..., -1.4525,  0.2444, -1.1111],
│   │                       [-1.0216,  0.0535,  0.9221,  ..., -0.4830,  0.5677, -0.5216],
│   │                       ...,
│   │                       [ 0.6065, -0.2625,  0.3126,  ..., -0.4642,  1.8629,  0.1939],
│   │                       [-0.2452, -0.6615,  1.1839,  ..., -0.5300,  0.6109,  1.7217],
│   │                       [-0.4046, -0.1358,  0.1821,  ..., -0.6090, -0.0904, -0.4280]],
│   │             
│   │                      [[ 0.3077, -2.6103,  1.7602,  ..., -0.3602, -1.3573,  0.6411],
│   │                       [-0.0555,  0.5253,  0.7643,  ..., -1.0454, -0.3040, -0.8444],
│   │                       [ 0.1383,  1.0007,  0.3689,  ...,  2.5743, -0.2291, -1.2474],
│   │                       ...,
│   │                       [ 0.6294,  1.7052, -0.7016,  ..., -0.5466,  1.0688, -0.0701],
│   │                       [ 0.1549, -0.1369, -0.7417,  ..., -0.3182, -0.1640,  0.0117],
│   │                       [ 0.6572,  0.2568, -0.7329,  ..., -0.3183,  0.2869, -0.1443]],
│   │             
│   │                      [[ 0.4005,  0.3437, -0.8042,  ..., -0.4064,  0.8513,  1.5441],
│   │                       [-1.2601,  0.5662,  0.9433,  ..., -0.1410,  1.3128, -0.8031],
│   │                       [ 1.1336, -0.1418,  0.4478,  ...,  0.4578, -0.0801, -0.9054],
│   │                       ...,
│   │                       [ 1.3582, -0.3628,  0.9215,  ..., -0.3568,  0.1050, -0.5199],
│   │                       [-1.0494, -1.4886,  1.1468,  ...,  1.1487,  1.6004,  1.6156],
│   │                       [-1.5599, -0.5553,  1.0120,  ..., -0.9118, -0.2696, -0.6500]]],
│   │             
│   │             
│   │                     [[[ 0.3790,  0.4952,  0.9583,  ...,  1.6078, -1.9169,  0.6593],
│   │                       [-2.0161,  0.6956,  1.4897,  ..., -0.2996,  0.2989,  0.8017],
│   │                       [ 1.0756,  1.5056, -0.9895,  ...,  0.3288,  0.2282, -0.1108],
│   │                       ...,
│   │                       [-1.3647, -0.7291,  0.2110,  ..., -0.4885, -0.5885, -0.8581],
│   │                       [-0.9738,  0.5448, -0.4615,  ...,  0.1121, -0.2132,  0.5618],
│   │                       [ 0.3583, -0.9968, -1.7426,  ..., -0.9002, -0.3563,  0.0627]],
│   │             
│   │                      [[-1.3349, -0.3942,  0.0686,  ...,  0.1208, -0.7210, -1.1627],
│   │                       [-0.7972, -0.0787, -0.4310,  ...,  0.3201,  0.5161,  0.6024],
│   │                       [ 1.3342, -0.6145,  0.1597,  ..., -0.8645,  1.5023,  0.2659],
│   │                       ...,
│   │                       [ 1.0875,  1.0548,  1.3021,  ...,  0.5595,  2.3333, -1.7575],
│   │                       [-1.2752,  0.3317, -1.0211,  ..., -0.2166,  0.6199,  0.7361],
│   │                       [ 1.1687, -0.3197, -0.8722,  ...,  0.6154, -0.1088,  2.2219]],
│   │             
│   │                      [[ 1.6895,  1.0775,  0.1127,  ...,  0.1780,  0.1264,  0.2367],
│   │                       [ 0.1503, -0.0899, -0.2822,  ...,  2.0697, -0.0293,  1.3945],
│   │                       [-0.1978,  0.6818, -0.2833,  ...,  0.4031,  2.1341,  0.1339],
│   │                       ...,
│   │                       [ 1.5161,  0.0153,  1.0120,  ...,  0.9029, -0.7545, -0.9705],
│   │                       [ 0.2342, -1.6249, -0.5108,  ..., -0.0155,  1.2383,  0.3235],
│   │                       [-0.6319,  0.4116, -0.6257,  ...,  1.4758, -0.0299, -1.0663]]],
│   │             
│   │             
│   │                     [[[ 0.9283,  0.6500,  0.5173,  ...,  2.0467, -0.4429,  1.1248],
│   │                       [ 0.8320, -0.8628,  0.8742,  ..., -0.8610,  1.4943, -0.9498],
│   │                       [-0.5505, -0.8155,  0.7562,  ..., -0.6494,  2.8648, -0.1095],
│   │                       ...,
│   │                       [-0.1863, -1.5967, -0.7588,  ...,  1.9753,  0.1131,  0.4535],
│   │                       [ 0.7743, -0.6636,  0.1550,  ..., -1.0981, -0.6499,  0.9748],
│   │                       [ 0.6619, -2.1516, -0.1457,  ..., -1.4126, -0.5307, -0.4811]],
│   │             
│   │                      [[ 0.6020,  0.8825, -1.1413,  ..., -0.6595,  1.8105,  2.3747],
│   │                       [-0.2628,  0.6217,  1.2528,  ..., -0.4075, -2.4085,  1.5201],
│   │                       [-2.2201,  0.8497,  0.2535,  ..., -0.8446,  0.1772, -0.4793],
│   │                       ...,
│   │                       [ 0.4075,  0.7894,  1.6301,  ...,  0.8760, -2.2341,  0.2060],
│   │                       [ 0.2549,  0.9911, -0.5691,  ..., -0.1121,  0.4644, -0.3120],
│   │                       [-1.3921, -0.7974, -0.7567,  ..., -0.9839, -1.2291,  0.2704]],
│   │             
│   │                      [[ 0.2070,  0.0957, -0.2510,  ..., -0.6908, -0.8794,  0.6656],
│   │                       [ 0.6171,  0.4715, -0.9411,  ..., -0.7415,  1.0961, -2.2595],
│   │                       [ 0.3445,  0.6249, -0.0199,  ..., -0.3125, -0.4213,  1.2442],
│   │                       ...,
│   │                       [ 0.5347,  0.6183,  0.5974,  ...,  1.2906, -0.0496, -0.0317],
│   │                       [-1.0792,  0.4241, -2.3221,  ..., -2.2939, -1.1972, -0.1756],
│   │                       [ 0.0426, -0.2981,  0.0847,  ...,  0.8613,  0.9924,  1.6399]]]])
│   └── scalar --&gt; tensor([[-0.6807,  1.0771, -2.5015, -0.8446, -1.1525,  0.6298,  0.6040,  0.5141,
│                            1.7237, -1.4837, -1.4046, -1.0826],
│                          [-1.2288, -0.7352, -0.6939,  0.0372,  0.2893, -1.7995,  0.6441,  0.8621,
│                            0.2942,  0.2676, -0.9237,  0.0815],
│                          [ 0.8587,  0.4009, -0.5546, -0.3444,  0.9174,  0.7320, -1.2947,  1.8610,
│                            1.2781,  1.5011,  1.3377,  0.1983],
│                          [-0.1375,  0.6072, -0.1456,  0.1824, -0.8429, -0.4998, -1.3842,  2.2546,
│                            1.8075,  0.3514, -0.3376, -0.6651]])
└── reward --&gt; tensor([[0.7829],
                       [0.6920],
                       [0.7061],
                       [0.4563]])
</pre></div>
</td></tr></table></div>
<p>This code looks much simpler and clearer.</p>
</div>
</div>



           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../operation/index.html" class="btn btn-neutral float-right" title="Customized Operations For Different Fields" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../../tutorials/plugins/index.html" class="btn btn-neutral float-left" title="Plugins" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, HansBug, DI-engine&#39;s Contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
    <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: 4/merge
    <span class="fa fa-caret-down"></span>
  </span>
        <div class="rst-other-versions">
                <dl>
                    <dt>Branches</dt>
                        <dd><a href="index.html">4/merge</a></dd>
                        <dd><a href="../../../../main/best_practice/stack/index.html">main</a></dd>
                        <dd><a href="../../../../release/0.2.1/best_practice/stack/index.html">release/0.2.1</a></dd>
                </dl>
        </div>
    </div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>