

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Stack Structured Data &mdash; DI-treetensor 0.3.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Customized Operations For Different Fields" href="../operation/index.html" />
    <link rel="prev" title="Plugins" href="../../tutorials/plugins/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> DI-treetensor
          

          
          </a>

          
            
            
              <div class="version">
                0.3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/quick_start/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/plugins/index.html">Plugins</a></li>
</ul>
<p><span class="caption-text">Best Practice</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Stack Structured Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#stack-with-native-pytorch-api">Stack With Native PyTorch API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stack-with-treetensor-api">Stack With TreeTensor API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../operation/index.html">Customized Operations For Different Fields</a></li>
</ul>
<p><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/common/index.html">treetensor.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/config/index.html">treetensor.config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/numpy/index.html">treetensor.numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/torch/index.html">treetensor.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/utils/index.html">treetensor.utils</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DI-treetensor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Stack Structured Data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/best_practice/stack/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
    
    
  <section id="stack-structured-data">
<h1>Stack Structured Data<a class="headerlink" href="#stack-structured-data" title="Permalink to this headline">¶</a></h1>
<p>When the tensors form the tree structures, they are often needed to be stacked together, like the <a class="reference internal" href="../../api_doc/torch/funcs.stack.auto.html#torch.stack" title="torch.stack"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.stack()</span></code></a> implemented in torch.</p>
<section id="stack-with-native-pytorch-api">
<h2>Stack With Native PyTorch API<a class="headerlink" href="#stack-with-native-pytorch-api" title="Permalink to this headline">¶</a></h2>
<p>Here is the common code implement with native pytorch API.</p>
<div class="highlight-python notranslate"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="n">B</span> <span class="o">=</span> <span class="mi">4</span>


<span class="k">def</span> <span class="nf">get_item</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;obs&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;scalar&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
        <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>


<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_item</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">)]</span>


<span class="c1"># execute `stack` op</span>
<span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
    <span class="n">elem</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">stack</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">],</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;not support elem type: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">elem</span><span class="p">)))</span>


<span class="n">stacked_data</span> <span class="o">=</span> <span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># validate</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stacked_data</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">][</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">bool</span>
</pre></div></td></tr></table></div>
</div>
<p>The output should be like below, and the assertion statements can be all passed.</p>
<div class="highlight-text notranslate"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span>{&#39;obs&#39;: {&#39;scalar&#39;: tensor([[ 0.7308, -1.4616,  0.2253, -1.5058,  2.3172,  1.0580,  1.5714,  1.1061,
         -2.4785,  0.8000, -0.5666, -0.3207],
        [-1.8576, -0.3934, -0.1060,  1.0666, -2.2487, -0.5609, -0.3606, -0.2454,
         -0.2111, -0.7432,  0.7572,  1.2601],
        [-1.5649,  0.0038,  2.6281, -2.1528, -0.4865, -0.0994, -1.0762, -0.7551,
         -1.8853,  0.6051,  0.2830, -0.9936],
        [ 0.1310,  0.4530, -0.4502,  1.5790, -2.3341, -2.9555,  2.5993,  0.7126,
          0.5433,  0.4416,  0.8171,  1.3290]]), &#39;image&#39;: tensor([[[[ 1.4578, -0.1150,  0.2724,  ..., -0.2606, -2.1849, -1.0836],
          [-1.3019,  1.1053,  0.2853,  ..., -1.3223,  0.3658,  0.0659],
          [-0.8527,  1.6909,  2.3437,  ...,  0.0998,  0.2823, -0.4394],
          ...,
          [-0.6039,  0.2906, -0.7742,  ..., -0.5268,  0.3051, -0.4435],
          [ 0.3642,  2.0917, -0.1458,  ...,  0.1680, -0.8853, -0.1848],
          [-0.4562,  0.1865, -0.4635,  ...,  1.5745, -0.2581,  1.5514]],

         [[ 1.1405,  0.4390, -1.5619,  ...,  0.7846,  0.5697, -0.4095],
          [ 1.2038, -0.3167, -1.5976,  ..., -0.5086,  2.4547,  1.2472],
          [-1.4536, -0.3405,  1.6482,  ...,  0.2858, -0.1832, -0.2121],
          ...,
          [-0.7758,  1.1830,  0.2789,  ..., -0.9132,  0.0193,  0.5879],
          [-0.3200,  0.4458, -1.0870,  ..., -0.6239, -0.7174, -2.9405],
          [-0.0913,  2.4399, -1.1086,  ..., -0.1326, -0.4207,  0.0692]],

         [[-0.3037, -1.5461,  0.0048,  ...,  2.0638, -0.4891,  1.0851],
          [ 0.8701,  2.4103,  0.6037,  ..., -1.0222, -0.3061,  0.9070],
          [ 0.7126,  0.7484,  0.9198,  ..., -0.3775, -0.2468,  0.2676],
          ...,
          [-0.1677,  1.7162, -0.2770,  ..., -1.3034,  2.1981,  1.2602],
          [ 2.8233, -0.1544,  1.0831,  ...,  0.1928, -1.2372,  1.6501],
          [ 3.3014, -0.5000,  1.4609,  ..., -0.8118,  0.6385,  0.5758]]],


        [[[-0.3157,  0.2565, -0.6482,  ..., -0.2623,  0.2475, -1.2786],
          [-2.0888,  0.2207,  0.2152,  ..., -0.0766, -0.5028, -0.9714],
          [-2.6504,  0.5397,  0.9439,  ...,  0.4863,  2.8263,  1.4871],
          ...,
          [ 0.5750,  0.6573, -0.7814,  ...,  0.3377,  0.2109,  0.0133],
          [-0.7209,  0.5728, -0.6200,  ...,  0.7122, -2.8368, -0.6051],
          [ 1.7983, -1.1353,  0.4611,  ...,  1.0611,  0.6325,  0.4967]],

         [[ 1.5817, -0.9695,  0.2670,  ...,  1.3494, -0.6112, -0.8253],
          [ 0.9345,  0.1467,  1.1260,  ..., -0.5552, -0.0137,  0.2036],
          [-2.1750,  0.8582,  0.6962,  ...,  0.3895, -0.1829,  0.1443],
          ...,
          [ 0.2017, -0.3744, -1.8380,  ...,  2.2461, -1.6622,  0.8952],
          [-0.1579,  0.7212, -0.0710,  ...,  0.5152,  1.6259,  0.2002],
          [ 0.2640, -0.6796,  1.0917,  ...,  1.0686,  0.1066, -0.5144]],

         [[ 0.8710, -0.8239,  1.4369,  ...,  0.8582,  0.5267, -1.8037],
          [ 0.1377,  0.7734,  1.1773,  ..., -0.8720,  0.2924,  0.0166],
          [-0.2001, -0.0787, -0.6121,  ...,  0.7865,  0.1455, -1.3296],
          ...,
          [ 1.8840, -0.9233, -1.5184,  ...,  1.0922, -0.3808,  0.5373],
          [-0.7461,  0.0765,  0.0390,  ...,  0.4314,  0.6865,  0.6035],
          [ 0.0454,  0.3558, -1.0923,  ..., -0.2193, -0.0457, -0.0528]]],


        [[[ 1.9788,  0.2050,  0.5777,  ...,  0.6773, -2.1575, -0.9963],
          [-1.6870, -0.2578, -1.4282,  ..., -0.1409,  0.2408, -1.4975],
          [ 1.2749, -1.0324, -0.1462,  ...,  0.7874, -0.3612, -0.2238],
          ...,
          [-0.6781,  0.7865, -2.3196,  ..., -0.7246,  0.0736, -0.2586],
          [-1.9255, -1.2828, -0.1821,  ...,  1.4469,  0.1694, -2.3028],
          [ 0.2816,  0.4785, -0.6980,  ...,  0.7839,  0.0642,  0.7246]],

         [[-0.6715,  0.6044,  2.1000,  ..., -0.0228,  0.0434,  0.9999],
          [-1.9767, -0.8163,  0.3226,  ...,  0.4488,  1.1736, -1.2500],
          [-1.4497,  0.0037, -0.2341,  ...,  0.6291, -0.2821,  0.0813],
          ...,
          [ 0.6948,  0.3725,  0.0988,  ..., -0.3107, -1.0240, -0.9899],
          [-0.9848,  0.4855,  0.3915,  ..., -1.2927,  0.5239,  0.8028],
          [ 0.7155,  0.5391, -0.0975,  ...,  1.6614,  0.0149,  0.1148]],

         [[-0.5450,  0.3677,  0.6350,  ...,  0.3713,  0.5635,  2.2150],
          [-0.7127,  0.2463,  0.1475,  ...,  0.5068,  0.1385,  0.4002],
          [ 0.8679, -1.2365,  1.4172,  ...,  0.4019, -1.3853,  0.6757],
          ...,
          [-0.6620,  0.5537,  0.1821,  ..., -0.0327, -0.2534, -0.4086],
          [-1.4577,  0.1288, -0.0042,  ...,  1.2203, -0.6469, -1.1270],
          [-0.3095, -0.4173, -1.2685,  ...,  1.4730,  0.9242, -0.3027]]],


        [[[-0.6072,  0.4219, -1.2209,  ..., -0.0816, -1.0071,  2.0426],
          [-0.5131,  0.9845, -0.2623,  ...,  1.0275,  0.6216, -0.9140],
          [ 2.0890, -0.1853, -0.1590,  ...,  1.0510,  1.4281,  0.5704],
          ...,
          [ 0.9323, -0.6041, -0.7441,  ..., -1.0007,  0.0742, -0.6185],
          [ 0.0193, -1.1010, -0.1996,  ..., -0.9662,  0.7720,  0.0257],
          [-0.1627, -0.1840, -1.3089,  ..., -1.1460, -0.3770, -1.2371]],

         [[-1.0725,  1.8427, -0.0516,  ..., -0.9380,  0.8308,  0.3570],
          [ 0.9718,  1.0006, -0.0320,  ..., -0.4915, -2.0347,  0.5317],
          [ 0.1647, -0.5360, -0.9714,  ..., -1.2879, -1.6400, -0.2491],
          ...,
          [ 0.7147, -1.2523, -1.9155,  ..., -0.9638, -1.0507, -0.4464],
          [ 0.2269,  0.7663, -0.1666,  ..., -0.1156, -0.0494, -1.3747],
          [-1.1758, -0.0492,  0.8960,  ..., -0.7772,  0.0839,  1.0492]],

         [[ 0.1775, -0.2985,  0.4574,  ...,  0.6142, -0.0828,  1.5976],
          [ 0.3464, -0.8700,  0.4284,  ...,  0.0255, -0.5357, -0.3418],
          [ 1.7702,  0.5697, -0.4013,  ..., -0.5772, -0.5848,  0.7901],
          ...,
          [-0.1565, -1.0919,  0.0372,  ...,  1.3593, -1.0637, -2.4971],
          [-1.3793, -0.9026,  0.5877,  ..., -1.3937, -0.7982,  0.5243],
          [ 1.4847,  0.2080, -0.3746,  ..., -1.0111,  0.2111, -0.6305]]]])}, &#39;action&#39;: tensor([[7],
        [8],
        [5],
        [6]]), &#39;reward&#39;: tensor([[0.2544],
        [0.1836],
        [0.3910],
        [0.5583]]), &#39;done&#39;: tensor([False, False, False, False])}
</pre></div></td></tr></table></div>
</div>
<p>We can see that the structure process function need to be fully implemented (like the function <code class="docutils literal notranslate"><span class="pre">stack</span></code>). This code is actually not clear, and due to hard coding, if you need to support more data types (such as integer), you must make special modifications to the function.</p>
</section>
<section id="stack-with-treetensor-api">
<h2>Stack With TreeTensor API<a class="headerlink" href="#stack-with-treetensor-api" title="Permalink to this headline">¶</a></h2>
<p>The same workflow can be implemented with treetensor API like the code below.</p>
<div class="highlight-python notranslate"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">import</span> <span class="nn">treetensor.torch</span> <span class="k">as</span> <span class="nn">ttorch</span>

<span class="n">B</span> <span class="o">=</span> <span class="mi">4</span>


<span class="k">def</span> <span class="nf">get_item</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;obs&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;scalar&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
        <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>


<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_item</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">)]</span>
<span class="c1"># execute `stack` op</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">ttorch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
<span class="n">stacked_data</span> <span class="o">=</span> <span class="n">ttorch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># validate</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stacked_data</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="o">.</span><span class="n">reward</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">B</span><span class="p">,)</span>
<span class="k">assert</span> <span class="n">stacked_data</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">bool</span>
</pre></div></td></tr></table></div>
</div>
<p>The output should be like below, and the assertion statements can be all passed as well.</p>
<div class="highlight-text notranslate"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span>&lt;Tensor 0x7f99463c4250&gt;
├── &#39;action&#39; --&gt; tensor([[5],
│                        [3],
│                        [7],
│                        [5]])
├── &#39;done&#39; --&gt; tensor([False, False, False, False])
├── &#39;obs&#39; --&gt; &lt;Tensor 0x7f99463c4290&gt;
│   ├── &#39;image&#39; --&gt; tensor([[[[ 0.5891,  1.1897,  0.1961,  ...,  0.6079, -0.1907,  0.3283],
│   │                         [-0.4049,  0.3899, -0.2427,  ..., -0.0068, -0.7877, -1.7833],
│   │                         [ 0.9808,  0.1489, -0.5968,  ...,  1.6916, -0.5435, -2.1233],
│   │                         ...,
│   │                         [-0.1900, -2.2678,  0.0430,  ...,  0.7129,  1.1549,  0.5799],
│   │                         [-0.0565, -0.3808,  0.1268,  ..., -1.4834, -0.5636,  0.5538],
│   │                         [ 1.4938,  0.6915, -1.1573,  ..., -0.1465,  0.2106, -1.5106]],
│   │               
│   │                        [[ 0.5883,  0.5932, -0.0594,  ..., -1.2082, -0.4855,  0.5927],
│   │                         [ 0.1665,  0.8183,  1.9964,  ...,  1.1274,  2.1669, -0.7475],
│   │                         [ 1.1957, -0.8388, -0.1668,  ...,  0.0626, -1.3684, -0.5569],
│   │                         ...,
│   │                         [ 0.1593, -2.0632, -1.3121,  ...,  1.4127,  0.1005, -0.1979],
│   │                         [ 0.0293, -1.0968, -1.1844,  ...,  0.5565,  1.1070,  0.2460],
│   │                         [-0.1347, -0.8405,  0.3934,  ..., -1.1838, -0.9808,  1.2444]],
│   │               
│   │                        [[ 1.9593, -0.2059,  1.9322,  ...,  0.6230, -0.3117,  1.2468],
│   │                         [-0.3993, -0.1637, -0.5772,  ..., -0.1488,  1.6102, -1.3110],
│   │                         [-2.7313,  2.9494, -0.3572,  ...,  1.1435,  0.5476, -0.0919],
│   │                         ...,
│   │                         [ 0.9749,  0.1950,  0.8566,  ..., -2.0402, -2.5797,  1.7194],
│   │                         [-1.9178, -0.5027,  2.8476,  ...,  0.6077, -1.3352,  1.4019],
│   │                         [ 0.6600,  0.6767,  0.7280,  ..., -1.5013, -0.4741,  1.5053]]],
│   │               
│   │               
│   │                       [[[ 0.3648,  0.4563,  1.1529,  ..., -0.5753,  0.1651,  0.7775],
│   │                         [-0.8830, -1.8343,  0.9008,  ...,  0.0086,  0.6596,  2.2092],
│   │                         [-0.1973, -2.0886, -1.8446,  ..., -0.1186, -0.9929,  1.1190],
│   │                         ...,
│   │                         [ 0.8941,  0.7153,  0.3429,  ...,  1.3621, -1.0893,  1.0475],
│   │                         [ 0.5609,  1.9400,  0.2478,  ...,  0.8707, -0.4228,  0.9477],
│   │                         [ 0.0846,  1.0162, -1.9470,  ..., -0.2675,  1.0298,  0.0655]],
│   │               
│   │                        [[ 0.9728, -1.3902,  0.2133,  ..., -0.5704,  1.4726,  1.0706],
│   │                         [ 0.5547, -0.5075, -0.0653,  ...,  0.8865, -2.1175, -0.5308],
│   │                         [-2.6782,  0.5007, -0.3066,  ..., -0.6346, -0.5440,  0.3372],
│   │                         ...,
│   │                         [ 1.0546,  0.9391, -0.1888,  ...,  0.8734, -0.3902, -1.5863],
│   │                         [-0.7903, -0.1124,  1.3923,  ..., -1.1902, -1.5691,  0.1736],
│   │                         [ 0.3428,  0.2955,  0.2225,  ..., -0.5251,  2.6104, -0.2350]],
│   │               
│   │                        [[-0.2568, -0.0169,  1.4014,  ..., -2.0467,  0.3316, -0.9249],
│   │                         [-0.6432, -0.2247,  2.1402,  ..., -1.5687,  0.2196,  0.5319],
│   │                         [ 2.3722, -0.0162, -0.7388,  ...,  0.2486, -0.0757, -0.7665],
│   │                         ...,
│   │                         [-1.2125, -1.2941,  0.2510,  ...,  0.6255, -1.9605, -0.9656],
│   │                         [-1.5626,  0.8052,  0.5866,  ..., -0.0324,  0.6716, -0.6986],
│   │                         [-0.2589,  0.3651,  0.8614,  ...,  1.2462, -1.5926, -0.1898]]],
│   │               
│   │               
│   │                       [[[ 0.1106, -0.4243, -1.6074,  ...,  0.5288,  0.7817,  0.7822],
│   │                         [ 0.2879, -0.7389,  0.9267,  ..., -1.6670,  0.2390,  0.6665],
│   │                         [ 1.0181, -0.6542,  0.0831,  ...,  0.6634,  0.6025,  1.8312],
│   │                         ...,
│   │                         [-0.1460,  1.3988, -0.3675,  ..., -1.6805, -0.4499, -0.6231],
│   │                         [-0.1906,  0.2849,  2.4741,  ..., -2.0408,  1.8740, -0.7991],
│   │                         [-0.1001,  0.1627,  0.3885,  ..., -0.2924,  0.6356, -1.1722]],
│   │               
│   │                        [[ 2.1246, -0.8039,  0.1297,  ..., -0.1509,  1.1816, -1.1132],
│   │                         [-1.0355,  1.4839,  0.3806,  ...,  0.0587,  1.0022,  0.1488],
│   │                         [ 0.5954,  0.8114, -0.5287,  ...,  0.2246, -0.5002,  0.5453],
│   │                         ...,
│   │                         [-0.6178, -0.1497,  2.5338,  ...,  0.3856,  0.0112, -0.2266],
│   │                         [ 0.9286,  1.1153, -1.2725,  ..., -1.0406,  0.2747,  0.6350],
│   │                         [ 0.8528, -0.5262, -1.3973,  ...,  0.2516, -0.6856,  1.2251]],
│   │               
│   │                        [[ 0.7634,  0.8459,  0.1104,  ..., -2.4331,  0.1925,  1.3935],
│   │                         [-0.8582,  0.8493,  0.5636,  ...,  0.9004,  0.1839,  2.4310],
│   │                         [ 0.0912, -0.4748,  0.1456,  ...,  1.1074, -0.4015, -0.4634],
│   │                         ...,
│   │                         [-1.0877,  0.1415, -1.5395,  ...,  2.5600,  1.0120, -0.6063],
│   │                         [-2.1293,  0.5113,  0.4952,  ..., -0.8497, -1.7736, -0.4868],
│   │                         [-0.0556, -1.0796,  2.0542,  ..., -1.2365,  0.7862, -0.6869]]],
│   │               
│   │               
│   │                       [[[-0.8034,  0.5283, -0.6934,  ..., -2.4581, -0.3294,  0.6542],
│   │                         [-0.2661,  0.5173, -1.7617,  ...,  0.3881,  0.9686, -0.7268],
│   │                         [-1.6668, -0.3203, -0.8993,  ...,  0.3036,  0.3497,  1.9106],
│   │                         ...,
│   │                         [ 0.2205,  0.7396,  1.0724,  ...,  2.0573,  0.2218,  0.9962],
│   │                         [ 1.0482, -0.3668, -0.3045,  ..., -0.2780,  0.1496,  1.5208],
│   │                         [-1.0018,  0.4002,  0.3473,  ..., -0.6419, -0.4161,  1.8354]],
│   │               
│   │                        [[ 1.0531, -0.0273,  0.3512,  ...,  0.1645,  2.8558, -0.9278],
│   │                         [ 1.1673,  0.3110, -1.0503,  ...,  1.8113,  0.5032,  0.4853],
│   │                         [-0.5954, -1.1281,  1.0319,  ...,  1.3097, -0.4984, -1.7414],
│   │                         ...,
│   │                         [ 1.0509, -0.1710, -0.4081,  ..., -1.0519,  1.0258, -2.0395],
│   │                         [-1.1825, -1.1307, -0.3033,  ..., -1.7021, -1.8702, -0.1090],
│   │                         [ 0.6776,  0.8386,  0.7948,  ...,  2.6575, -2.6983, -0.7859]],
│   │               
│   │                        [[ 0.9976, -1.2059,  0.3259,  ...,  1.9329, -0.4193, -0.2699],
│   │                         [-0.1679, -2.4342, -0.9444,  ...,  1.0556, -1.2505, -1.3575],
│   │                         [ 0.7816,  0.3830,  0.3998,  ...,  0.9911, -0.2644,  0.2371],
│   │                         ...,
│   │                         [-0.3307, -0.8662,  1.5240,  ...,  2.0803, -1.2508,  0.2319],
│   │                         [ 1.2415,  0.9887, -0.2042,  ..., -0.2210,  0.0974, -0.5977],
│   │                         [ 0.0852,  0.5051, -0.7732,  ..., -1.1790, -0.8152, -0.6516]]]])
│   └── &#39;scalar&#39; --&gt; tensor([[-0.0868, -1.1643, -0.0426,  0.4049,  0.2958, -0.1583, -0.4165, -0.3681,
│                              0.4141,  0.1795, -0.1673,  2.8908],
│                            [-0.3523, -1.7127,  0.6872,  1.7986,  1.2901,  1.1839,  0.9477,  0.6800,
│                              1.1242,  0.4334,  0.1122, -1.4602],
│                            [-0.5399, -1.0941,  0.3123, -0.3763, -0.6897, -1.2522, -1.4666,  0.2409,
│                              0.2633,  0.6646, -0.2296, -2.6857],
│                            [ 0.7111,  0.5437, -2.4783,  1.2808, -0.9556, -1.2367,  0.6829, -0.3590,
│                             -0.9332, -2.3502,  1.0554,  0.2482]])
└── &#39;reward&#39; --&gt; tensor([[0.7536],
                         [0.7218],
                         [0.0805],
                         [0.7664]])
</pre></div></td></tr></table></div>
</div>
<p>This code looks much simpler and clearer.</p>
</section>
</section>



           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../operation/index.html" class="btn btn-neutral float-right" title="Customized Operations For Different Fields" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../../tutorials/plugins/index.html" class="btn btn-neutral float-left" title="Plugins" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, HansBug, DI-engine&#39;s Contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
    <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: dev/stream
    <span class="fa fa-caret-down"></span>
  </span>
        <div class="rst-other-versions">
                <dl>
                    <dt>Tags</dt>
                        <dd><a href="../../../../v0.2.1/best_practice/stack/index.html">v0.2.1</a></dd>
                        <dd><a href="../../../../v0.3.0/best_practice/stack/index.html">v0.3.0</a></dd>
                </dl>
                <dl>
                    <dt>Branches</dt>
                        <dd><a href="../../../py310/best_practice/stack/index.html">dev/py310</a></dd>
                        <dd><a href="index.html">dev/stream</a></dd>
                        <dd><a href="../../../../main/best_practice/stack/index.html">main</a></dd>
                        <dd><a href="../../../../run/xdemos/best_practice/stack/index.html">run/xdemos</a></dd>
                </dl>
        </div>
    </div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>